<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIB34D Adaptive Wearable Designer</title>
    <style>
        :root {
            color-scheme: dark;
            --bg: radial-gradient(circle at 20% 20%, #101826, #04060b 65%);
            --panel-bg: rgba(12, 18, 32, 0.85);
            --accent: #4c9fff;
            --muted: rgba(255, 255, 255, 0.55);
        }

        body {
            margin: 0;
            font-family: 'Inter', system-ui;
            background: var(--bg);
            color: #f5f7fb;
            height: 100vh;
            display: grid;
            grid-template-columns: minmax(0, 1.4fr) minmax(320px, 0.6fr);
        }

        .canvas-stack {
            position: relative;
            display: grid;
            place-items: center;
            overflow: hidden;
        }

        .canvas-stack canvas {
            position: absolute;
            width: 88vmin;
            height: 88vmin;
            max-width: 880px;
            max-height: 880px;
            border-radius: 28px;
            backdrop-filter: blur(20px);
        }

        .canvas-stack canvas:nth-child(1) { mix-blend-mode: screen; opacity: 0.35; }
        .canvas-stack canvas:nth-child(2) { mix-blend-mode: lighten; opacity: 0.45; }
        .canvas-stack canvas:nth-child(3) { mix-blend-mode: normal; }
        .canvas-stack canvas:nth-child(4) { mix-blend-mode: screen; opacity: 0.6; }
        .canvas-stack canvas:nth-child(5) { mix-blend-mode: screen; opacity: 0.8; }

        aside {
            padding: 32px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            background: linear-gradient(160deg, rgba(8, 10, 20, 0.9), rgba(12, 18, 32, 0.75));
            border-left: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(24px);
        }

        .panel {
            background: var(--panel-bg);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 20px 40px rgba(10, 20, 40, 0.35);
        }

        .panel h2 {
            font-size: 1rem;
            letter-spacing: 0.08em;
            margin: 0 0 12px;
            text-transform: uppercase;
            color: var(--muted);
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }

        .metric {
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: rgba(255, 255, 255, 0.03);
            padding: 12px 14px;
            border-radius: 14px;
        }

        .metric span:first-child {
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            color: var(--muted);
        }

        .metric span:last-child {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--accent);
        }

        .pattern-card {
            display: grid;
            gap: 12px;
        }

        .pattern-card h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .pattern-card p {
            margin: 0;
            color: rgba(255, 255, 255, 0.65);
            line-height: 1.4;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(76, 159, 255, 0.1);
            color: var(--accent);
        }

        button {
            background: rgba(76, 159, 255, 0.1);
            border: 1px solid rgba(76, 159, 255, 0.3);
            color: var(--accent);
            padding: 12px 16px;
            border-radius: 14px;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
            cursor: pointer;
        }

        button:hover {
            background: rgba(76, 159, 255, 0.2);
        }

        .variation-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .variation-controls input[type="range"] {
            width: 100%;
        }

        .consent-grid {
            display: grid;
            gap: 12px;
        }

        .consent-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            background: rgba(255, 255, 255, 0.03);
            padding: 12px 14px;
            border-radius: 14px;
        }

        .consent-toggle div {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .consent-toggle span {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .consent-toggle small {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            letter-spacing: 0.03em;
        }

        .consent-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--accent);
        }

        .consent-status {
            margin-top: 14px;
            font-size: 0.78rem;
            color: rgba(255, 255, 255, 0.65);
            line-height: 1.5;
        }

        .consent-status strong {
            color: var(--accent);
        }

        .compliance-log {
            list-style: none;
            margin: 18px 0 0;
            padding: 0;
            display: grid;
            gap: 10px;
        }

        .compliance-log li {
            background: rgba(255, 255, 255, 0.03);
            padding: 10px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.78);
        }

        .compliance-log li span {
            display: block;
            margin-top: 4px;
            font-size: 0.68rem;
            color: rgba(255, 255, 255, 0.5);
            letter-spacing: 0.04em;
        }

        .panel button.secondary {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.12);
            color: rgba(255, 255, 255, 0.85);
        }

        .panel button.secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="canvas-stack" id="canvasStack">
        <canvas id="background-canvas"></canvas>
        <canvas id="shadow-canvas"></canvas>
        <canvas id="content-canvas"></canvas>
        <canvas id="highlight-canvas"></canvas>
        <canvas id="accent-canvas"></canvas>
    </div>
    <aside>
        <section class="panel">
            <h2>Adaptive Intent</h2>
            <div class="metric-grid" id="intentMetrics">
                <div class="metric"><span>Focus</span><span id="focusMetric">0.50</span></div>
                <div class="metric"><span>Engagement</span><span id="engagementMetric">0.40</span></div>
                <div class="metric"><span>Velocity</span><span id="velocityMetric">0.00</span></div>
                <div class="metric"><span>Stress</span><span id="stressMetric">0.20</span></div>
            </div>
        </section>
        <section class="panel">
            <h2>Pattern Activation</h2>
            <div class="pattern-card">
                <span class="tag" id="patternTier">STARTER</span>
                <h3 id="patternName">Neuro Glance Feed</h3>
                <p id="patternDescription">Micro-summaries that respond to attention bursts and biometric calmness.</p>
                <div class="tag" id="integrationTag">Figma: vib34d-neuro-glance-feed</div>
            </div>
        </section>
        <section class="panel">
            <h2>Variations</h2>
            <div class="variation-controls">
                <input type="range" min="0" max="99" value="0" id="variationSlider">
                <button id="randomizeBtn">Randomize</button>
            </div>
            <p style="margin-top: 12px; color: rgba(255,255,255,0.6); font-size: 0.85rem;" id="variationLabel">1 - TETRAHEDRON LATTICE</p>
        </section>
        <section class="panel" id="licenseAnalyticsPanel">
            <h2>License Attestation</h2>
            <div class="metric-grid">
                <div class="metric"><span>Active Pack</span><span id="activePackMetric">Unassigned</span></div>
                <div class="metric"><span>Profiles</span><span id="profileCountMetric">0</span></div>
                <div class="metric"><span>Validations</span><span id="validationMetric">0</span></div>
                <div class="metric"><span>Errors</span><span id="errorMetric">0</span></div>
            </div>
            <ul class="compliance-log" id="licenseHistory"></ul>
            <button class="secondary" id="downloadLicenseAnalyticsBtn">Download Analytics JSON</button>
        </section>
        <section class="panel" id="telemetryConsentPanel"></section>
    </aside>

    <script type="module">
        import { createAdaptiveSDK } from './src/core/AdaptiveSDK.js';
        import { LayoutAnnotation } from './src/ui/adaptive/annotations/LayoutAnnotation.js';
        import { ComplianceVaultTelemetryProvider } from './src/product/telemetry/ComplianceVaultTelemetryProvider.js';
        import { createConsentPanel } from './src/ui/components/ConsentPanel.js';

        const complianceVaultProvider = new ComplianceVaultTelemetryProvider({ maxRecords: 24 });
        let consentPanel;

        const adaptiveSDK = createAdaptiveSDK({
            telemetry: {
                enabled: true,
                defaultConsent: { analytics: false, biometric: false },
                onConsentDecision: (snapshot, metadata) => {
                    consentPanel?.handleConsentDecision(snapshot, metadata);
                }
            },
            telemetryProviders: [complianceVaultProvider],
            marketplaceHooks: {
                onPatternChange: updatePatternPanel,
                onAdaptiveUpdate: handleAdaptiveUpdate
            }
        });

        const {
            engine,
            registerLayoutAnnotation,
            updateTelemetryConsent,
            getTelemetryConsent,
            getTelemetryAuditTrail
        } = adaptiveSDK;

        const telemetryHarness = adaptiveSDK.telemetry;
        const licensePack = telemetryHarness.registerLicenseAttestationProfilePack('enterprise-saas', {
            regions: ['global', 'na'],
            applyDefault: true
        });
        if (licensePack.defaultProfileId) {
            telemetryHarness.setDefaultLicenseAttestationProfile(licensePack.defaultProfileId);
            telemetryHarness.recordAudit('system.license.attestation_profile_applied', {
                profileId: licensePack.defaultProfileId,
                packId: licensePack.id,
                sla: null
            }, 'system');
        }

        registerLayoutAnnotation(new class extends LayoutAnnotation {
            constructor() {
                super({ id: 'demo-insight', priority: 5 });
            }

            shouldApply({ layout }) {
                return layout.intensity > 0.7;
            }

            build({ layout }) {
                return {
                    type: 'insight',
                    message: `High intent detected (${layout.intensity.toFixed(2)})`
                };
            }
        }());

        window.vib34dEngine = engine;
        window.vib34dComplianceVault = complianceVaultProvider;

        const variationSlider = document.getElementById('variationSlider');
        const randomizeBtn = document.getElementById('randomizeBtn');
        const variationLabel = document.getElementById('variationLabel');
        const focusMetric = document.getElementById('focusMetric');
        const engagementMetric = document.getElementById('engagementMetric');
        const velocityMetric = document.getElementById('velocityMetric');
        const stressMetric = document.getElementById('stressMetric');
        const consentPanelContainer = document.getElementById('telemetryConsentPanel');
        const activePackMetric = document.getElementById('activePackMetric');
        const profileCountMetric = document.getElementById('profileCountMetric');
        const validationMetric = document.getElementById('validationMetric');
        const errorMetric = document.getElementById('errorMetric');
        const licenseHistoryList = document.getElementById('licenseHistory');
        const downloadLicenseAnalyticsBtn = document.getElementById('downloadLicenseAnalyticsBtn');

        consentPanel = createConsentPanel({
            container: consentPanelContainer,
            consentOptions: [
                {
                    classification: 'system',
                    title: 'System Diagnostics',
                    description: 'Required for runtime health and adapter lifecycle.'
                },
                {
                    classification: 'compliance',
                    title: 'Compliance & Audit',
                    description: 'Records schema issues and consent changes.'
                },
                {
                    classification: 'interaction',
                    title: 'Interaction Feedback',
                    description: 'Tracks gestures and adaptive layout reactions.'
                },
                {
                    classification: 'analytics',
                    title: 'Analytics',
                    description: 'Enables aggregated layout performance telemetry.'
                },
                {
                    classification: 'biometric',
                    title: 'Biometric Streams',
                    description: 'Includes heart rate and stress telemetry.'
                }
            ],
            getTelemetryConsent,
            getComplianceRecords: () => complianceVaultProvider.getRecords(),
            getTelemetryAuditTrail,
            refreshInterval: 6000,
            downloadFileNamePrefix: 'vib34d-compliance-log',
            onConsentToggle: (classification, enabled) => {
                updateTelemetryConsent({ [classification]: enabled }, { source: 'wearable-designer-ui' });
            },
            trackConsentToggle: (classification, enabled) => {
                telemetryHarness.track('privacy.consent.ui_toggle', { classification, enabled }, { classification: 'compliance' });
            }
        }).mount();

        const simulatedProfileId = licensePack.defaultProfileId || licensePack.profileIds?.[0] || null;

        function renderLicenseHistory(summary) {
            const entries = summary.recentHistory.slice(-6).reverse();
            licenseHistoryList.innerHTML = '';
            if (entries.length === 0) {
                const placeholder = document.createElement('li');
                const meta = document.createElement('span');
                meta.textContent = 'Waiting for attestation activity...';
                placeholder.appendChild(meta);
                licenseHistoryList.appendChild(placeholder);
                return;
            }

            for (const entry of entries) {
                const item = document.createElement('li');
                const title = document.createElement('strong');
                title.textContent = entry.event
                    .replace('compliance.license.', '')
                    .replace('system.license.', '')
                    .replace(/_/g, ' ')
                    .toUpperCase();
                item.appendChild(title);

                const detail = document.createElement('span');
                const pack = entry.packId ? summary.packs.find(p => p.id === entry.packId) : null;
                const parts = [];
                if (pack?.name) parts.push(pack.name);
                if (entry.profileId) parts.push(entry.profileId);
                if (entry.details?.status) {
                    parts.push(entry.details.status.toUpperCase());
                } else if (entry.details?.reason) {
                    parts.push(entry.details.reason);
                } else if (typeof entry.details?.delayMs === 'number') {
                    const minutes = (entry.details.delayMs / 60000).toFixed(1);
                    parts.push(`Next in ${minutes}m`);
                }
                detail.textContent = parts.join(' â€¢ ') || 'Recorded';
                item.appendChild(detail);
                licenseHistoryList.appendChild(item);
            }
        }

        function refreshLicenseAnalytics() {
            const summary = adaptiveSDK.getLicenseAttestationAnalytics();
            const activePack = summary.activePackId
                ? summary.packs.find(pack => pack.id === summary.activePackId)
                : summary.packs.find(pack => pack.id === licensePack.id) || summary.packs[0] || null;

            activePackMetric.textContent = activePack?.name || 'Unassigned';
            profileCountMetric.textContent = String(summary.totalProfiles);
            validationMetric.textContent = String(summary.overall.validations);
            errorMetric.textContent = String(summary.overall.errors);
            renderLicenseHistory(summary);
        }

        function downloadLicenseAnalyticsReport() {
            const report = adaptiveSDK.getLicenseAttestationAnalyticsReport({ packId: licensePack.id });
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const anchor = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            anchor.href = url;
            anchor.download = `vib34d-license-analytics-${timestamp}.json`;
            document.body.appendChild(anchor);
            anchor.click();
            setTimeout(() => {
                document.body.removeChild(anchor);
                URL.revokeObjectURL(url);
            }, 0);

            telemetryHarness.track('compliance.license.analytics_exported', {
                packId: licensePack.id,
                profileId: licensePack.defaultProfileId || null
            }, { classification: 'compliance' });
        }

        function simulateLicenseTelemetry() {
            if (!simulatedProfileId) return;
            const events = [
                'compliance.license.validation',
                'compliance.license.attestation',
                'compliance.license.entitlements',
                'compliance.license.attestor_error',
                'system.license.attestation_scheduled'
            ];
            const event = events[Math.floor(Math.random() * events.length)];
            const payload = {
                profileId: simulatedProfileId,
                packId: licensePack.id
            };

            switch (event) {
                case 'compliance.license.validation':
                    payload.result = { attestation: { valid: true }, entitlements: { entitlements: ['adaptive-ui'] } };
                    break;
                case 'compliance.license.attestation':
                    payload.attestation = { valid: true, attestedAt: new Date().toISOString() };
                    break;
                case 'compliance.license.entitlements':
                    payload.entitlements = { entitlements: ['marketplace', 'analytics'], updatedAt: new Date().toISOString() };
                    break;
                case 'compliance.license.attestor_error':
                    payload.type = 'validation';
                    payload.error = new Error('Simulated latency spike');
                    break;
                case 'system.license.attestation_scheduled':
                    payload.delayMs = 600000;
                    payload.context = { trigger: 'demo-scheduler' };
                    break;
                default:
                    break;
            }

            const classification = event.startsWith('system.') ? 'system' : 'compliance';
            telemetryHarness.recordAudit(event, payload, classification);
            refreshLicenseAnalytics();
        }

        refreshLicenseAnalytics();
        setInterval(refreshLicenseAnalytics, 6000);
        setInterval(simulateLicenseTelemetry, 12000);

        downloadLicenseAnalyticsBtn?.addEventListener('click', downloadLicenseAnalyticsReport);

        variationSlider.addEventListener('input', (event) => {
            const value = Number(event.target.value);
            engine.setVariation(value);
            variationLabel.textContent = `${value + 1} - ${engine.variationManager.getVariationName(value)}`;
        });

        randomizeBtn.addEventListener('click', () => {
            engine.randomVariation();
            variationSlider.value = engine.currentVariation;
            variationLabel.textContent = `${engine.currentVariation + 1} - ${engine.variationManager.getVariationName(engine.currentVariation)}`;
        });

        function updatePatternPanel(spec) {
            document.getElementById('patternTier').textContent = spec.monetization.tier.toUpperCase();
            document.getElementById('patternName').textContent = spec.pattern?.name || 'Adaptive Pattern';
            document.getElementById('patternDescription').textContent = spec.pattern?.description || 'Dynamic mapping ready for commercialization.';
            document.getElementById('integrationTag').textContent = `Figma: ${spec.integration.figmaPlugin}`;
        }

        function handleAdaptiveUpdate({ context, layout }) {
            focusMetric.textContent = context.focusVector.x.toFixed(2);
            engagementMetric.textContent = context.engagementLevel.toFixed(2);
            velocityMetric.textContent = layout.motion.velocity.toFixed(2);
            stressMetric.textContent = context.biometricStress.toFixed(2);
        }

        document.addEventListener('pointermove', event => {
            const x = event.clientX / window.innerWidth;
            const y = event.clientY / window.innerHeight;
            engine.sensoryBridge.ingest('eye-tracking', { x, y, depth: 0.25 + 0.15 * Math.sin(x * Math.PI) }, 0.9);
            engine.sensoryBridge.ingest('neural-intent', { x: (x - 0.5) * 0.8, y: (0.5 - y) * 0.8, engagement: 0.5 + (0.5 - Math.abs(0.5 - x)) * 0.3 }, 0.7);
        });

        setInterval(() => {
            const stress = 0.15 + Math.random() * 0.15;
            engine.sensoryBridge.ingest('biometric', { stress, heartRate: 70 + Math.random() * 6 }, 0.6);
            engine.sensoryBridge.ingest('ambient', { luminance: 0.4 + Math.random() * 0.2, motion: Math.random() * 0.3 }, 0.5);
        }, 2400);
    </script>
</body>
</html>
