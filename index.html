<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIB34D Engine - Clean Architecture</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet" onerror="console.warn('Google Fonts failed to load - using fallback')">
    
    <!-- Organized CSS Architecture -->
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/header.css">
    <link rel="stylesheet" href="styles/controls.css">
    <link rel="stylesheet" href="styles/reactivity.css">
    <link rel="stylesheet" href="styles/mobile.css">
    <link rel="stylesheet" href="styles/animations.css">
</head>
<body class="loading">
    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="vib3d-logo-container">
            <div class="vib3d-logo">
                <span class="logo-text">VIB</span><span class="special-three" id="dynamicThree">3</span><span class="logo-text">-4D</span>
            </div>
            <div class="logo-subtitle">
                <span class="subtitle-line-1">Polytopal Projection</span>
                <span class="subtitle-line-2">Parametric Engine</span>
            </div>
            <div class="logo-credits">
                <span class="by-text">by GEN-RL-Millz</span>
                <span class="developer-credit">[Paul Phillips]</span>
            </div>
        </div>
        
        <div class="action-buttons-primary">
            <button class="primary-btn" onclick="createTradingCard()" title="Generate Trading Card">TRADING CARD</button>
            <button class="primary-btn" onclick="saveToGallery()" title="Save Current State">SAVE</button>
        </div>
        
        <div class="navigation-buttons">
            <button class="nav-btn" onclick="openGallery()" title="Gallery">GALLERY</button>
            <button class="nav-btn" onclick="openViewer()" title="Viewer">VIEWER</button>
        </div>
        
        <div class="control-toggles">
            <button class="toggle-btn" onclick="toggleAudio()" onmouseenter="showAudioPopout()" onmouseleave="hideAudioPopout()" title="Audio Reactivity" id="audioToggle">AUDIO</button>
            <button class="toggle-btn" onclick="toggleInteractivity()" onmouseenter="showReactPopout()" onmouseleave="hideReactPopout()" title="Interactive Control" id="interactivityToggle">REACT</button>
            
            <!-- Audio Reactivity Popout Menu - ORIGINAL 3x3 GRID SYSTEM -->
            <div class="popout-menu audio-popout" id="audioPopout">
                <div class="audio-grid">
                    <div class="audio-header"></div>
                    <div class="audio-header">COL</div>
                    <div class="audio-header">GEO</div>
                    <div class="audio-header">MOV</div>
                    
                    <!-- Low Sensitivity Row -->
                    <div class="audio-label">L</div>
                    <div class="audio-cell" onclick="toggleAudioCell('lowColor')">
                        <input type="checkbox" id="lowColor">
                        <span class="cell-text">Subtle</span>
                    </div>
                    <div class="audio-cell" onclick="toggleAudioCell('lowGeometry')">
                        <input type="checkbox" id="lowGeometry">
                        <span class="cell-text">Gentle</span>
                    </div>
                    <div class="audio-cell" onclick="toggleAudioCell('lowMovement')">
                        <input type="checkbox" id="lowMovement" checked>
                        <span class="cell-text">Smooth</span>
                    </div>
                    
                    <!-- Medium Sensitivity Row -->
                    <div class="audio-label">M</div>
                    <div class="audio-cell" onclick="toggleAudioCell('medColor')">
                        <input type="checkbox" id="medColor" checked>
                        <span class="cell-text">Reactive</span>
                    </div>
                    <div class="audio-cell" onclick="toggleAudioCell('medGeometry')">
                        <input type="checkbox" id="medGeometry">
                        <span class="cell-text">Morph</span>
                    </div>
                    <div class="audio-cell" onclick="toggleAudioCell('medMovement')">
                        <input type="checkbox" id="medMovement">
                        <span class="cell-text">Wave</span>
                    </div>
                    
                    <!-- High Sensitivity Row -->
                    <div class="audio-label">H</div>
                    <div class="audio-cell" onclick="toggleAudioCell('highColor')">
                        <input type="checkbox" id="highColor">
                        <span class="cell-text">Intense</span>
                    </div>
                    <div class="audio-cell" onclick="toggleAudioCell('highGeometry')">
                        <input type="checkbox" id="highGeometry" checked>
                        <span class="cell-text">Wild</span>
                    </div>
                    <div class="audio-cell" onclick="toggleAudioCell('highMovement')">
                        <input type="checkbox" id="highMovement">
                        <span class="cell-text">Chaos</span>
                    </div>
                </div>
                <div class="audio-note">Audio sensitivity levels: L=Low, M=Medium, H=High</div>
            </div>
            
            <!-- Interactive Reactivity Popout Menu - ORIGINAL 4x4 GRID SYSTEM -->
            <div class="popout-menu react-popout" id="reactPopout">
                <div class="reactivity-grid">
                    <div class="reactivity-header"></div>
                    <div class="reactivity-header">MOVE</div>
                    <div class="reactivity-header">TAP</div>
                    <div class="reactivity-header">ROLL</div>
                    
                    <!-- Faceted Row -->
                    <div class="reactivity-label">FAC</div>
                    <label class="reactivity-cell">
                        <input type="checkbox" id="facetedMouse" checked onchange="toggleSystemReactivity('faceted', 'mouse', this.checked)">
                        <span class="cell-text">Rotate</span>
                    </label>
                    <label class="reactivity-cell">
                        <input type="checkbox" id="facetedClick" checked onchange="toggleSystemReactivity('faceted', 'click', this.checked)">
                        <span class="cell-text">Flash</span>
                    </label>
                    <label class="reactivity-cell">
                        <input type="checkbox" id="facetedScroll" onchange="toggleSystemReactivity('faceted', 'scroll', this.checked)">
                        <span class="cell-text">Scale</span>
                    </label>
                    
                    <!-- Quantum Row -->
                    <div class="reactivity-label">QUA</div>
                    <label class="reactivity-cell">
                        <input type="checkbox" id="quantumMouse" onchange="toggleSystemReactivity('quantum', 'mouse', this.checked)">
                        <span class="cell-text">Warp</span>
                    </label>
                    <label class="reactivity-cell">
                        <input type="checkbox" id="quantumClick" onchange="toggleSystemReactivity('quantum', 'click', this.checked)">
                        <span class="cell-text">Pulse</span>
                    </label>
                    <label class="reactivity-cell">
                        <input type="checkbox" id="quantumScroll" checked onchange="toggleSystemReactivity('quantum', 'scroll', this.checked)">
                        <span class="cell-text">Phase</span>
                    </label>
                    
                    <!-- Holographic Row -->
                    <div class="reactivity-label">HOL</div>
                    <label class="reactivity-cell">
                        <input type="checkbox" id="holographicMouse" onchange="toggleSystemReactivity('holographic', 'mouse', this.checked)">
                        <span class="cell-text">Shimmer</span>
                    </label>
                    <label class="reactivity-cell">
                        <input type="checkbox" id="holographicClick" onchange="toggleSystemReactivity('holographic', 'click', this.checked)">
                        <span class="cell-text">Ripple</span>
                    </label>
                    <label class="reactivity-cell">
                        <input type="checkbox" id="holographicScroll" onchange="toggleSystemReactivity('holographic', 'scroll', this.checked)">
                        <span class="cell-text">Depth</span>
                    </label>
                    
                    <!-- Mixed Row -->
                    <div class="reactivity-label">MIX</div>
                    <label class="reactivity-cell">
                        <input type="checkbox" id="mixedMouse" onchange="toggleSystemReactivity('mixed', 'mouse', this.checked)">
                        <span class="cell-text">Fac+Holo</span>
                    </label>
                    <label class="reactivity-cell">
                        <input type="checkbox" id="mixedClick" onchange="toggleSystemReactivity('mixed', 'click', this.checked)">
                        <span class="cell-text">Multi</span>
                    </label>
                    <label class="reactivity-cell">
                        <input type="checkbox" id="mixedScroll" onchange="toggleSystemReactivity('mixed', 'scroll', this.checked)">
                        <span class="cell-text">Blend</span>
                    </label>
                </div>
                <div class="reactivity-note">Mix and match any system's behavior with any interaction type</div>
            </div>
        </div>
    </div>

    <!-- Main Canvas Container -->
    <div class="canvas-container" id="canvasContainer">
        <!-- Dynamic Canvas Containers - Canvases created/destroyed per system -->
        <div class="holographic-layers" id="vib34dLayers" style="display: block;"></div>
        <div class="holographic-layers" id="quantumLayers" style="display: none;"></div>
        <div class="holographic-layers" id="holographicLayers" style="display: none;"></div>
        <div class="holographic-layers" id="polychoraLayers" style="display: none;"></div>
    </div>

    <!-- Control Panel -->
    <div class="control-panel" id="controlPanel">
        <div class="panel-header" id="panelHeader">
            <span>VIB3-4D POLYTOPE PROJECTION ENGINE</span>
            <button class="mobile-collapse-btn" onclick="toggleMobilePanel()" style="display: none;">‚ñº</button>
        </div>

        <!-- System Selection (moved from top bar) -->
        <div class="control-section" id="systemSection">
            <div class="section-title">System</div>
            <div class="system-selector-panel">
                <button class="system-btn active" data-system="faceted" onclick="switchSystem('faceted')">
                    üî∑ FACETED
                </button>
                <button class="system-btn" data-system="quantum" onclick="switchSystem('quantum')">
                    üåå QUANTUM
                </button>
                <button class="system-btn" data-system="holographic" onclick="switchSystem('holographic')">
                    ‚ú® HOLOGRAPHIC
                </button>
                <button class="system-btn" data-system="polychora" onclick="switchSystem('polychora')">
                    üîÆ POLYCHORA
                </button>
            </div>
        </div>

        <!-- Geometry Selection -->
        <div class="control-section" id="geometrySection">
            <div class="section-title">Geometry</div>
            <div class="geometry-grid" id="geometryGrid">
                <!-- Geometry buttons populated by JavaScript -->
            </div>
        </div>

        <!-- Parameter Controls -->
        <div class="control-section">
            <div class="section-title">4D Rotations</div>
            
            <div class="control-group">
                <div class="control-label">
                    <span>X-W Rotation</span>
                    <span class="control-value" id="rot4dXW-display">0.00</span>
                </div>
                <input type="range" id="rot4dXW" class="control-slider" min="-6.28" max="6.28" step="0.01" value="0"
                       oninput="updateParameter('rot4dXW', this.value)">
            </div>

            <div class="control-group">
                <div class="control-label">
                    <span>Y-W Rotation</span>
                    <span class="control-value" id="rot4dYW-display">0.00</span>
                </div>
                <input type="range" id="rot4dYW" class="control-slider" min="-6.28" max="6.28" step="0.01" value="0"
                       oninput="updateParameter('rot4dYW', this.value)">
            </div>

            <div class="control-group">
                <div class="control-label">
                    <span>Z-W Rotation</span>
                    <span class="control-value" id="rot4dZW-display">0.00</span>
                </div>
                <input type="range" id="rot4dZW" class="control-slider" min="-6.28" max="6.28" step="0.01" value="0"
                       oninput="updateParameter('rot4dZW', this.value)">
            </div>
        </div>

        <!-- Visual Parameters -->
        <div class="control-section">
            <div class="section-title">Visual Parameters</div>
            
            <div class="control-group">
                <div class="control-label">
                    <span>Grid Density</span>
                    <span class="control-value" id="gridDensity-display">15</span>
                </div>
                <input type="range" id="gridDensity" class="control-slider" min="5" max="100" step="1" value="15"
                       oninput="updateParameter('gridDensity', this.value)">
            </div>

            <div class="control-group">
                <div class="control-label">
                    <span>Morph Factor</span>
                    <span class="control-value" id="morphFactor-display">1.00</span>
                </div>
                <input type="range" id="morphFactor" class="control-slider" min="0" max="2" step="0.01" value="1"
                       oninput="updateParameter('morphFactor', this.value)">
            </div>

            <div class="control-group">
                <div class="control-label">
                    <span>Chaos</span>
                    <span class="control-value" id="chaos-display">0.20</span>
                </div>
                <input type="range" id="chaos" class="control-slider" min="0" max="1" step="0.01" value="0.2"
                       oninput="updateParameter('chaos', this.value)">
            </div>

            <div class="control-group">
                <div class="control-label">
                    <span>Speed</span>
                    <span class="control-value" id="speed-display">1.00</span>
                </div>
                <input type="range" id="speed" class="control-slider" min="0.1" max="3" step="0.01" value="1"
                       oninput="updateParameter('speed', this.value)">
            </div>
        </div>

        <!-- Color Parameters -->
        <div class="control-section">
            <div class="section-title">Color Parameters</div>
            
            <div class="control-group">
                <div class="control-label">
                    <span>Hue</span>
                    <span class="control-value" id="hue-display">200</span>
                </div>
                <input type="range" id="hue" class="control-slider" min="0" max="360" step="1" value="200"
                       oninput="updateParameter('hue', this.value)">
            </div>

            <div class="control-group">
                <div class="control-label">
                    <span>Intensity</span>
                    <span class="control-value" id="intensity-display">0.50</span>
                </div>
                <input type="range" id="intensity" class="control-slider" min="0" max="1" step="0.01" value="0.5"
                       oninput="updateParameter('intensity', this.value)">
            </div>

            <div class="control-group">
                <div class="control-label">
                    <span>Saturation</span>
                    <span class="control-value" id="saturation-display">0.80</span>
                </div>
                <input type="range" id="saturation" class="control-slider" min="0" max="1" step="0.01" value="0.8"
                       oninput="updateParameter('saturation', this.value)">
            </div>
        </div>

        <!-- Actions -->
        <div class="control-section">
            <div class="section-title">Actions</div>
            <button class="panel-btn action-randomize-lite" onclick="randomizeLite()">RANDOMIZE LITE</button>
            <button class="panel-btn action-randomize" onclick="randomizeAll()">RANDOMIZE ALL</button>
            <button class="panel-btn action-reset" onclick="resetAll()">RESET ALL</button>
        </div>
    </div>

    <!-- URL Parameter Handler (runs first) -->
    <script type="module" src="js/core/url-params.js"></script>

    <!-- Gallery Preview Fix (runs early for gallery previews) -->
    <script type="module" src="js/core/gallery-preview-fix.js"></script>

    <!-- Core JavaScript Modules (NEW CLEAN ARCHITECTURE) - Order matters for globals -->
    <script type="module" src="js/audio/audio-engine.js"></script>
    <script type="module" src="js/controls/ui-handlers.js"></script>
    <script type="module" src="js/gallery/gallery-manager.js"></script>
    <script type="module" src="js/interactions/device-tilt.js"></script>
    
    <!-- üåü SPECTACULAR DYNAMIC LOGO SYSTEM - BEYOND EXPECTATIONS! -->
    <script type="module" src="js/logo/dynamic-logo.js"></script>
    
    <!-- Initialize globals and user parameter state BEFORE main app -->
    <script>
        // Initialize global state that modules need
        window.userParameterState = {};
        // CRITICAL FIX: Don't overwrite currentSystem if URL parameters already set it
        if (!window.currentSystem) {
            window.currentSystem = 'faceted';
            console.log('üîß Global: Set currentSystem to default faceted');
        } else {
            console.log(`üîß Global: Preserving existing currentSystem = '${window.currentSystem}'`);
        }
        window.moduleReady = false;
        
        // Initialize geometries data
        window.geometries = {
            faceted: ['TETRAHEDRON', 'HYPERCUBE', 'SPHERE', 'TORUS', 'KLEIN BOTTLE', 'FRACTAL', 'WAVE', 'CRYSTAL'],
            quantum: ['TETRAHEDRON', 'HYPERCUBE', 'SPHERE', 'TORUS', 'KLEIN BOTTLE', 'FRACTAL', 'WAVE', 'CRYSTAL'],
            holographic: ['HOLOGRAPHIC'], // Single holographic mode
            polychora: ['5-CELL', 'TESSERACT', '16-CELL', '24-CELL', '600-CELL', '120-CELL']
        };
        
        console.log('üîß Global state initialized for clean architecture');
    </script>

    <!-- Main Application Module -->
    <script type="module">
        (async function() {
            try {
                console.log('üì¶ Starting system imports...');
                
                // Import the main app first
                const VIB34DApp = (await import('./js/core/app.js')).default;
                console.log('‚úÖ VIB34DApp imported');
                
                // Try to import system engines - make them optional for clean architecture demo
                let VIB34DIntegratedEngine, QuantumEngine, RealHolographicSystem, PolychoraSystem;
                let CollectionManager, UnifiedSaveManager, ParameterMapper, CanvasManager, TradingCardGenerator, ReactivityManager;
                
                try {
                    const coreEngine = await import('./src/core/Engine.js');
                    VIB34DIntegratedEngine = coreEngine.VIB34DIntegratedEngine;
                    console.log('‚úÖ VIB34DIntegratedEngine imported');
                } catch (e) {
                    console.warn('‚ö†Ô∏è VIB34DIntegratedEngine not available:', e.message);
                }
                
                try {
                    const quantumEngine = await import('./src/quantum/QuantumEngine.js');
                    QuantumEngine = quantumEngine.QuantumEngine;
                    console.log('‚úÖ QuantumEngine imported');
                } catch (e) {
                    console.warn('‚ö†Ô∏è QuantumEngine not available:', e.message);
                }
                
                try {
                    const holoSystem = await import('./src/holograms/RealHolographicSystem.js');
                    RealHolographicSystem = holoSystem.RealHolographicSystem;
                    console.log('‚úÖ RealHolographicSystem imported');
                } catch (e) {
                    console.warn('‚ö†Ô∏è RealHolographicSystem not available:', e.message);
                }
                
                try {
                    const newPolySystem = await import('./src/core/PolychoraSystemNew.js');
                    NewPolychoraEngine = newPolySystem.NewPolychoraEngine;
                    console.log('‚úÖ NEW 4D Polychora Engine imported with VIB34D DNA');
                } catch (e) {
                    console.warn('‚ö†Ô∏è New Polychora Engine not available:', e.message);
                    // Fallback to old system if new one fails
                    try {
                        const polySystem = await import('./src/core/PolychoraSystem.js');
                        NewPolychoraEngine = polySystem.PolychoraSystem;
                        console.log('‚úÖ Fallback to old PolychoraSystem');
                    } catch (e2) {
                        console.warn('‚ö†Ô∏è No Polychora system available:', e2.message);
                    }
                }
                
                // Import other components with fallbacks
                try {
                    const canvasManager = await import('./src/core/CanvasManager.js');
                    CanvasManager = canvasManager.CanvasManager;
                } catch (e) {
                    console.warn('‚ö†Ô∏è CanvasManager not available - using stub');
                }
                
                try {
                    const unifiedReactivityManager = await import('./src/core/UnifiedReactivityManager.js');
                    UnifiedReactivityManager = unifiedReactivityManager.UnifiedReactivityManager;
                    console.log('‚úÖ UnifiedReactivityManager imported');
                } catch (e) {
                    console.warn('‚ö†Ô∏è UnifiedReactivityManager not available');
                }
                
                try {
                    const reactivityManager = await import('./src/core/ReactivityManager.js');
                    ReactivityManager = reactivityManager.ReactivityManager;
                } catch (e) {
                    console.warn('‚ö†Ô∏è ReactivityManager not available - using stub');
                }

                // Store engine classes globally for system switching
                window.engineClasses = {
                    VIB34DIntegratedEngine,
                    QuantumEngine,
                    RealHolographicSystem,
                    NewPolychoraEngine
                };
                
                console.log('üì¶ Engine classes stored:', Object.keys(window.engineClasses).filter(k => window.engineClasses[k]));

                // Initialize Unified Reactivity Manager FIRST
                if (UnifiedReactivityManager) {
                    const reactivityManager = new UnifiedReactivityManager();
                    console.log('‚úÖ UnifiedReactivityManager initialized');
                } else {
                    // Fallback getCurrentReactivityState function
                    window.getCurrentReactivityState = function() {
                        return {
                            system: window.currentSystem || 'faceted',
                            mouse: { faceted: true, quantum: false, holographic: false, polychora: false, mixed: false },
                            click: { faceted: true, quantum: false, holographic: false, polychora: false, mixed: false },
                            scroll: { faceted: true, quantum: false, holographic: false, polychora: false, mixed: false },
                            audio: window.audioEnabled || false,
                            interactivity: window.interactivityEnabled !== false,
                            deviceTilt: window.deviceTiltHandler?.isEnabled || false
                        };
                    };
                    console.log('‚ö†Ô∏è Using fallback getCurrentReactivityState');
                }

                // Initialize VIB34D Application
                const app = new VIB34DApp();
                window.vib34dApp = app;
                
                // CRITICAL FIX: Ensure global functions are available IMMEDIATELY for gallery previews
                await app.initialize();
                
                // Force check that essential functions are global
                if (!window.syncVisualizerToUI) {
                    console.error('üö® CRITICAL: syncVisualizerToUI not available globally after app init');
                } else {
                    console.log('‚úÖ Essential functions available globally');
                }

                // Initialize default system
                const initialSystem = window.currentSystem || 'faceted';
                if (window.switchSystem) {
                    await window.switchSystem(initialSystem);
                }
                
                if (window.setupGeometry) {
                    window.setupGeometry(initialSystem);
                }

                window.moduleReady = true;
                document.body.classList.remove('loading');

                console.log('üöÄ VIB34D Clean Architecture System Loaded');
                
                // TESTING MODE: Run architecture tests if requested
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('testing-mode')) {
                    console.log('üß™ TESTING MODE: Running architecture validation...');
                    
                    // Add test results overlay
                    const testOverlay = document.createElement('div');
                    testOverlay.id = 'test-overlay';
                    testOverlay.style.cssText = `
                        position: fixed;
                        top: 60px;
                        left: 20px;
                        width: 400px;
                        max-height: 80vh;
                        overflow-y: auto;
                        background: rgba(0, 0, 0, 0.95);
                        border: 2px solid #00ffff;
                        border-radius: 10px;
                        padding: 15px;
                        font-family: 'Orbitron', monospace;
                        font-size: 0.8rem;
                        color: #fff;
                        z-index: 9999;
                    `;
                    testOverlay.innerHTML = `
                        <h3 style="color: #00ffff; margin-bottom: 10px;">üß™ ARCHITECTURE TEST</h3>
                        <div id="test-results"></div>
                    `;
                    document.body.appendChild(testOverlay);
                    
                    // Run tests  
                    setTimeout(runArchitectureTests, 1000);
                    
                    function runArchitectureTests() {
                    const results = document.getElementById('test-results');
                    let passedTests = 0;
                    let totalTests = 0;
                    
                    function logTest(message, passed) {
                        totalTests++;
                        if (passed) passedTests++;
                        
                        const div = document.createElement('div');
                        div.style.cssText = `color: ${passed ? '#00ff00' : '#ff4444'}; margin: 2px 0;`;
                        div.innerHTML = `${passed ? '‚úÖ' : '‚ùå'} ${message}`;
                        results.appendChild(div);
                    }
                    
                    // Test essential functions
                    logTest('window.switchSystem available', typeof window.switchSystem === 'function');
                    logTest('window.selectGeometry available', typeof window.selectGeometry === 'function');
                    logTest('window.updateParameter available', typeof window.updateParameter === 'function');
                    logTest('window.randomizeAll available', typeof window.randomizeAll === 'function');
                    logTest('window.resetAll available', typeof window.resetAll === 'function');
                    
                    // Test DOM elements
                    logTest('Canvas Container exists', !!document.getElementById('canvasContainer'));
                    logTest('Control Panel exists', !!document.getElementById('controlPanel'));
                    logTest('Panel Header exists', !!document.getElementById('panelHeader'));
                    logTest('Faceted Layers exist', !!document.getElementById('vib34dLayers'));
                    
                    // Test parameter controls
                    const params = ['rot4dXW', 'rot4dYW', 'rot4dZW', 'gridDensity', 'morphFactor', 'chaos', 'speed', 'hue', 'intensity', 'saturation'];
                    params.forEach(param => {
                        const slider = document.getElementById(param);
                        logTest(`${param} slider exists`, !!slider);
                    });
                    
                    // Test system buttons
                    const systems = ['faceted', 'quantum', 'holographic', 'polychora'];
                    systems.forEach(system => {
                        const btn = document.querySelector(`[data-system="${system}"]`);
                        logTest(`${system} button exists`, !!btn);
                    });
                    
                    // Final results
                    const passRate = ((passedTests / totalTests) * 100).toFixed(1);
                    const finalDiv = document.createElement('div');
                    finalDiv.style.cssText = `
                        color: ${passRate >= 90 ? '#00ff00' : passRate >= 70 ? '#ffff00' : '#ff4444'};
                        font-weight: bold;
                        margin-top: 10px;
                        padding: 10px;
                        border-top: 1px solid #333;
                    `;
                    finalDiv.innerHTML = `
                        <div>üìä RESULT: ${passedTests}/${totalTests} (${passRate}%)</div>
                        <div>${passRate >= 90 ? '‚úÖ ARCHITECTURE READY' : passRate >= 70 ? '‚ö†Ô∏è NEEDS FIXES' : '‚ùå CRITICAL ISSUES'}</div>
                    `;
                    results.appendChild(finalDiv);
                    
                    console.log(`üß™ Architecture test complete: ${passedTests}/${totalTests} passed (${passRate}%)`);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Failed to initialize VIB34D system:', error);
                document.body.classList.remove('loading');
                
                // Show error overlay
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(255, 0, 0, 0.9);
                    color: white;
                    padding: 20px;
                    border-radius: 10px;
                    font-family: 'Orbitron', monospace;
                    z-index: 10000;
                    max-width: 80vw;
                `;
                errorDiv.innerHTML = `
                    <h3>‚ùå VIB34D Initialization Failed</h3>
                    <p>${error.message}</p>
                    <small>Check console for details</small>
                `;
                document.body.appendChild(errorDiv);
            }
        })();

        // ‚ö° POPOUT MENU FUNCTIONS - Toggle button reactivity grids
        let audioPopoutTimer = null;
        let reactPopoutTimer = null;

        window.showAudioPopout = function() {
            clearTimeout(audioPopoutTimer);
            const popout = document.getElementById('audioPopout');
            if (popout) {
                popout.classList.add('show');
            }
        };

        window.hideAudioPopout = function() {
            audioPopoutTimer = setTimeout(() => {
                const popout = document.getElementById('audioPopout');
                if (popout && !popout.matches(':hover')) {
                    popout.classList.remove('show');
                }
            }, 300);
        };

        window.showReactPopout = function() {
            clearTimeout(reactPopoutTimer);
            const popout = document.getElementById('reactPopout');
            if (popout) {
                popout.classList.add('show');
            }
        };

        window.hideReactPopout = function() {
            reactPopoutTimer = setTimeout(() => {
                const popout = document.getElementById('reactPopout');
                if (popout && !popout.matches(':hover')) {
                    popout.classList.remove('show');
                }
            }, 300);
        };

        // ORIGINAL toggleSystemReactivity function with column exclusivity and mixed modes
        window.toggleSystemReactivity = function(system, interaction, enabled) {
            console.log(`‚ö° toggleSystemReactivity: ${system} ${interaction} = ${enabled}`);
            
            if (enabled) {
                // When enabling a checkbox, disable others in the same column
                const columnCheckboxes = {
                    'mouse': ['facetedMouse', 'quantumMouse', 'holographicMouse', 'mixedMouse'],
                    'click': ['facetedClick', 'quantumClick', 'holographicClick', 'mixedClick'],
                    'scroll': ['facetedScroll', 'quantumScroll', 'holographicScroll', 'mixedScroll']
                };
                
                const currentColumnIds = columnCheckboxes[interaction];
                const currentCheckboxId = system + interaction.charAt(0).toUpperCase() + interaction.slice(1);
                
                if (currentColumnIds) {
                    currentColumnIds.forEach(id => {
                        const checkbox = document.getElementById(id);
                        if (checkbox && id !== currentCheckboxId) {
                            checkbox.checked = false; // Uncheck others in column
                        }
                    });
                }
            }
            
            // Apply to reactivity manager
            if (window.reactivityManager) {
                if (interaction === 'mouse') {
                    if (enabled) {
                        if (system === 'faceted') {
                            window.reactivityManager.setMouseMode('rotate');
                        } else if (system === 'quantum') {
                            window.reactivityManager.setMouseMode('warp');
                        } else if (system === 'holographic') {
                            window.reactivityManager.setMouseMode('distance');
                        } else if (system === 'mixed') {
                            window.reactivityManager.setMouseMode('mixed_faceted_holo');
                        }
                        window.reactivityManager.toggleMouse(true);
                    } else {
                        // Check if any mouse mode is still enabled
                        const anyMouseEnabled = 
                            document.getElementById('facetedMouse')?.checked ||
                            document.getElementById('quantumMouse')?.checked ||
                            document.getElementById('holographicMouse')?.checked ||
                            document.getElementById('mixedMouse')?.checked;
                        
                        if (!anyMouseEnabled) {
                            window.reactivityManager.toggleMouse(false);
                        }
                    }
                } else if (interaction === 'click') {
                    if (enabled) {
                        if (system === 'faceted') {
                            window.reactivityManager.setClickMode('flash');
                        } else if (system === 'quantum') {
                            window.reactivityManager.setClickMode('pulse');
                        } else if (system === 'holographic') {
                            window.reactivityManager.setClickMode('ripple');
                        } else if (system === 'mixed') {
                            window.reactivityManager.setClickMode('mixed_multi');
                        }
                        window.reactivityManager.toggleClick(true);
                    } else {
                        const anyClickEnabled = 
                            document.getElementById('facetedClick')?.checked ||
                            document.getElementById('quantumClick')?.checked ||
                            document.getElementById('holographicClick')?.checked ||
                            document.getElementById('mixedClick')?.checked;
                        
                        if (!anyClickEnabled) {
                            window.reactivityManager.toggleClick(false);
                        }
                    }
                } else if (interaction === 'scroll') {
                    if (enabled) {
                        if (system === 'faceted') {
                            window.reactivityManager.setScrollMode('scale');
                        } else if (system === 'quantum') {
                            window.reactivityManager.setScrollMode('phase');
                        } else if (system === 'holographic') {
                            window.reactivityManager.setScrollMode('depth');
                        } else if (system === 'mixed') {
                            window.reactivityManager.setScrollMode('mixed_blend');
                        }
                        window.reactivityManager.toggleScroll(true);
                    } else {
                        const anyScrollEnabled = 
                            document.getElementById('facetedScroll')?.checked ||
                            document.getElementById('quantumScroll')?.checked ||
                            document.getElementById('holographicScroll')?.checked ||
                            document.getElementById('mixedScroll')?.checked;
                        
                        if (!anyScrollEnabled) {
                            window.reactivityManager.toggleScroll(false);
                        }
                    }
                }
            }
        };

        // ORIGINAL toggleAudioCell function with column exclusivity
        window.toggleAudioCell = function(cellId) {
            const checkbox = document.getElementById(cellId);
            if (!checkbox) return;
            
            checkbox.checked = !checkbox.checked;
            const [sensitivity, mode] = cellId.match(/^(low|med|high)(Color|Geometry|Movement)$/)?.slice(1) || [];
            
            if (checkbox.checked && sensitivity && mode) {
                // Disable other checkboxes in the same column
                const sensitivities = ['low', 'med', 'high'];
                sensitivities.forEach(s => {
                    if (s !== sensitivity) {
                        const otherId = s + mode;
                        const otherCheckbox = document.getElementById(otherId);
                        if (otherCheckbox) otherCheckbox.checked = false;
                    }
                });
                
                // Apply audio settings
                if (window.audioEngine) {
                    const settings = {
                        colorSensitivity: document.querySelector('[id$="Color"]:checked')?.id.replace('Color', '') || 'med',
                        geometrySensitivity: document.querySelector('[id$="Geometry"]:checked')?.id.replace('Geometry', '') || 'med',
                        movementSensitivity: document.querySelector('[id$="Movement"]:checked')?.id.replace('Movement', '') || 'low'
                    };
                    
                    console.log(`üéµ Audio settings updated:`, settings);
                    if (window.audioEngine.updateSensitivity) {
                        window.audioEngine.updateSensitivity(settings);
                    }
                }
            }
        };

        // Reset reactivity grid to system defaults when switching visualizers
        window.resetReactivityGridToDefaults = function(system) {
            console.log(`üîÑ Resetting reactivity grid to ${system} defaults`);
            
            const systemDefaults = {
                faceted: {
                    mouse: 'faceted',
                    click: 'faceted',
                    scroll: null
                },
                quantum: {
                    mouse: null,
                    click: null,
                    scroll: 'quantum'
                },
                holographic: {
                    mouse: null,
                    click: null,
                    scroll: null
                },
                polychora: {
                    mouse: 'faceted',
                    click: 'faceted',
                    scroll: null
                }
            };
            
            const defaults = systemDefaults[system] || systemDefaults.faceted;
            
            // Clear all checkboxes first
            const allCheckboxes = [
                'facetedMouse', 'quantumMouse', 'holographicMouse', 'mixedMouse',
                'facetedClick', 'quantumClick', 'holographicClick', 'mixedClick', 
                'facetedScroll', 'quantumScroll', 'holographicScroll', 'mixedScroll'
            ];
            
            allCheckboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = false;
            });
            
            // Set system-appropriate defaults
            if (defaults.mouse) {
                const mouseCheckbox = document.getElementById(defaults.mouse + 'Mouse');
                if (mouseCheckbox) {
                    mouseCheckbox.checked = true;
                    toggleSystemReactivity(defaults.mouse, 'mouse', true);
                }
            }
            
            if (defaults.click) {
                const clickCheckbox = document.getElementById(defaults.click + 'Click');
                if (clickCheckbox) {
                    clickCheckbox.checked = true;
                    toggleSystemReactivity(defaults.click, 'click', true);
                }
            }
            
            if (defaults.scroll) {
                const scrollCheckbox = document.getElementById(defaults.scroll + 'Scroll');
                if (scrollCheckbox) {
                    scrollCheckbox.checked = true;
                    toggleSystemReactivity(defaults.scroll, 'scroll', true);
                }
            }
        };

        // üîÆ GEOMETRY SYSTEM - Setup geometry buttons for each system
        window.geometries = {
            faceted: ['Tetra', 'Cube', 'Sphere', 'Torus', 'Klein', 'Fractal', 'Wave', 'Crystal'],
            quantum: ['Q-Tetra', 'Q-Cube', 'Q-Sphere', 'Q-Torus', 'Q-Klein', 'Q-Fractal', 'Q-Wave', 'Q-Crystal'],
            holographic: ['H-Tetra', 'H-Cube', 'H-Sphere', 'H-Torus', 'H-Klein', 'H-Fractal', 'H-Wave', 'H-Crystal'],
            polychora: ['5-Cell', 'Tesseract', '16-Cell', '24-Cell', '600-Cell', '120-Cell', 'Hyper-Torus', 'Crystal-4D']
        };

        window.setupGeometry = function(system) {
            const grid = document.getElementById('geometryGrid');
            if (!grid) return;
            
            const geoList = window.geometries?.[system] || window.geometries?.faceted || [];
            
            grid.innerHTML = geoList.map((name, i) => {
                // Handle long names like HYPERTETRAHEDRON -> split into lines
                let displayName = name;
                if (name.length > 12) {
                    if (name.includes('-')) {
                        const parts = name.split('-');
                        displayName = `<div class="geom-btn-text"><div class="geom-btn-line">${parts[0]}</div><div class="geom-btn-line">${parts[1] || ''}</div></div>`;
                    } else {
                        displayName = `<div class="geom-btn-text"><div class="geom-btn-line">${name.substring(0, 6)}</div><div class="geom-btn-line">${name.substring(6)}</div></div>`;
                    }
                }
                
                return `<button class="geom-btn ${i === 0 ? 'active' : ''}" 
                               data-index="${i}" 
                               onclick="selectGeometry(${i})"
                               title="${name}">
                            ${displayName}
                        </button>`;
            }).join('');
            
            console.log(`üîÆ Geometry grid setup for ${system}: ${geoList.length} geometries`);
        };

        window.selectGeometry = function(index) {
            console.log(`üîÆ Selecting geometry ${index}`);
            
            // Update active button
            document.querySelectorAll('.geom-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            
            // Apply to current system
            if (window.updateParameter) {
                window.updateParameter('geometry', index);
            }
        };

        // ‚öôÔ∏è CRITICAL: updateParameter function - updates engines and displays
        window.updateParameter = function(param, value) {
            const numValue = parseFloat(value);
            
            // Store user's parameter choice for persistence
            if (!window.userParameterState) window.userParameterState = {};
            window.userParameterState[param] = numValue;
            console.log(`üíæ User parameter: ${param} = ${value}`);
            
            // Update the parameter display value
            const displayElement = document.getElementById(param + '-display');
            if (displayElement) {
                if (param === 'hue') {
                    displayElement.textContent = Math.round(numValue);
                } else if (['rot4dXW', 'rot4dYW', 'rot4dZW', 'morphFactor', 'chaos', 'speed', 'intensity', 'saturation'].includes(param)) {
                    displayElement.textContent = numValue.toFixed(2);
                } else if (param === 'gridDensity') {
                    displayElement.textContent = Math.round(numValue);
                }
            }
            
            // Route parameter to active engine
            const activeSystem = window.currentSystem || 'faceted';
            const engine = window.currentEngine;
            
            if (!engine) {
                console.warn(`‚ö†Ô∏è No active engine for ${activeSystem} - parameter queued`);
                return;
            }
            
            try {
                if (activeSystem === 'faceted') {
                    if (engine.parameterManager) {
                        engine.parameterManager.setParameter(param, numValue);
                        engine.updateVisualizers?.();
                    } else if (engine.updateParameter) {
                        engine.updateParameter(param, numValue);
                    }
                } else if (activeSystem === 'quantum') {
                    if (engine.updateParameter) {
                        engine.updateParameter(param, numValue);
                    } else if (engine.parameterManager) {
                        engine.parameterManager.setParameter(param, numValue);
                        engine.updateVisualizers?.();
                    }
                } else if (activeSystem === 'holographic') {
                    if (engine.updateParameter) {
                        engine.updateParameter(param, numValue);
                    } else if (engine.parameterManager) {
                        engine.parameterManager.setParameter(param, numValue);
                    }
                } else if (activeSystem === 'polychora') {
                    if (engine.updateParameters) {
                        engine.updateParameters({ [param]: numValue });
                    } else if (engine.updateParameter) {
                        engine.updateParameter(param, numValue);
                    }
                }
                
                console.log(`‚úÖ Parameter ${param} = ${value} applied to ${activeSystem}`);
            } catch (error) {
                console.error(`‚ùå Error updating parameter ${param} on ${activeSystem}:`, error);
            }
        };

        // üöÄ NAVIGATION FUNCTIONS - Smart parameter injection across pages
        window.openGallery = function() {
            const currentParams = window.getCurrentUIParameterState ? window.getCurrentUIParameterState() : {};
            const paramString = new URLSearchParams({
                system: window.currentSystem || 'faceted',
                ...currentParams
            }).toString();
            
            console.log('üé® Opening gallery with parameters:', paramString);
            window.location.href = `gallery.html?${paramString}`;
        };

        window.openViewer = function() {
            const currentParams = window.getCurrentUIParameterState ? window.getCurrentUIParameterState() : {};
            const paramString = new URLSearchParams({
                system: window.currentSystem || 'faceted',
                ...currentParams
            }).toString();
            
            console.log('üëÄ Opening viewer with parameters:', paramString);
            window.location.href = `viewer.html?${paramString}`;
        };

        // Get current UI parameter state
        window.getCurrentUIParameterState = function() {
            const parameterIds = [
                'rot4dXW', 'rot4dYW', 'rot4dZW', 
                'gridDensity', 'morphFactor', 'chaos', 
                'speed', 'hue', 'intensity', 'saturation'
            ];
            
            const currentParams = {};
            
            // Get values from sliders and user state
            parameterIds.forEach(param => {
                const slider = document.getElementById(param);
                if (slider) {
                    currentParams[param] = parseFloat(slider.value);
                } else if (window.userParameterState && window.userParameterState[param] !== undefined) {
                    currentParams[param] = window.userParameterState[param];
                }
            });
            
            // Get geometry selection
            const activeGeomBtn = document.querySelector('.geom-btn.active');
            if (activeGeomBtn) {
                currentParams.geometry = parseInt(activeGeomBtn.dataset.index) || 0;
            }
            
            return currentParams;
        };

        // Handle popout menu interactions - prevent closing when hovering
        document.addEventListener('DOMContentLoaded', function() {
            const audioPopout = document.getElementById('audioPopout');
            const reactPopout = document.getElementById('reactPopout');
            
            if (audioPopout) {
                audioPopout.addEventListener('mouseenter', () => {
                    clearTimeout(audioPopoutTimer);
                    audioPopout.classList.add('show');
                });
                
                audioPopout.addEventListener('mouseleave', () => {
                    window.hideAudioPopout();
                });
            }
            
            if (reactPopout) {
                reactPopout.addEventListener('mouseenter', () => {
                    clearTimeout(reactPopoutTimer);
                    reactPopout.classList.add('show');
                });
                
                reactPopout.addEventListener('mouseleave', () => {
                    window.hideReactPopout();
                });
            }
        });

    </script>
</body>
</html>
